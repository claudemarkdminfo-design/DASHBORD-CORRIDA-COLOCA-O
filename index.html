<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Público de Dados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Editor Público de Valores</h1>
        <p class="text-center text-gray-500 mb-6">Edite os valores abaixo. As alterações são sincronizadas em tempo real para todos os usuários.</p>

        <div id="auth-status" class="bg-blue-100 text-blue-800 text-sm p-3 rounded-lg mb-4 text-center">
            Aguardando autenticação...
        </div>

        <div class="space-y-4">
            <!-- Form to add new values -->
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="newValueInput" placeholder="Digite um novo valor..." class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                <button id="addValueButton" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Adicionar Valor</button>
            </div>
            
            <!-- List of editable values -->
            <div id="valuesContainer" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p class="text-center text-gray-400">Nenhum valor encontrado.</p>
            </div>
        </div>

        <div id="error-message" class="hidden mt-4 text-center p-3 rounded-lg bg-red-100 text-red-800"></div>
    </div>

    <script type="module">
        // Importa as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, arrayUnion, arrayRemove, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Elementos do DOM
        const authStatusElement = document.getElementById('auth-status');
        const valuesContainer = document.getElementById('valuesContainer');
        const newValueInput = document.getElementById('newValueInput');
        const addValueButton = document.getElementById('addValueButton');
        const errorMessageElement = document.getElementById('error-message');

        let db;
        let auth;
        let publicValuesRef;
        let userId = null;

        // Função para exibir mensagens de erro
        function displayError(message) {
            errorMessageElement.textContent = `Erro: ${message}`;
            errorMessageElement.classList.remove('hidden');
        }

        // Função de inicialização
        async function initFirebase() {
            try {
                // Inicializa o Firebase
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Define o caminho da coleção pública para esta aplicação
                publicValuesRef = doc(db, `artifacts/${appId}/public/data/editable-values`, 'public-data');

                // Listener de autenticação
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `Autenticado com sucesso. ID do Usuário: ${userId}`;
                        setupRealtimeListener();
                    } else {
                        // Caso a autenticação inicial não funcione, tenta uma autenticação anônima
                        authStatusElement.textContent = 'Aguardando autenticação anônima...';
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Erro na autenticação anônima:", error);
                            displayError("Falha na autenticação. Tente recarregar a página.");
                        }
                    }
                });

                // Se houver um token de autenticação inicial, tenta usá-lo
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Se não houver token, tenta autenticar anonimamente
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                displayError("Falha ao inicializar a aplicação. Verifique a configuração.");
            }
        }

        // Listener de dados em tempo real
        function setupRealtimeListener() {
            onSnapshot(publicValuesRef, (doc) => {
                const data = doc.data();
                const items = data ? data.items || [] : [];
                renderValues(items);
            }, (error) => {
                console.error("Erro ao receber dados em tempo real:", error);
                displayError("Erro na conexão com o banco de dados. Tente recarregar.");
            });
        }

        // Função para renderizar os valores na interface
        function renderValues(items) {
            if (items.length === 0) {
                valuesContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum valor encontrado. Adicione um para começar.</p>';
            } else {
                valuesContainer.innerHTML = '';
                items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('flex', 'items-center', 'justify-between', 'bg-white', 'p-3', 'rounded-lg', 'border', 'border-gray-200', 'shadow-sm', 'mb-2');
                    itemDiv.innerHTML = `
                        <span class="text-gray-700 flex-grow mr-4">${item.value}</span>
                        <div class="flex gap-2">
                            <button class="edit-btn bg-yellow-500 text-white p-2 rounded-md font-semibold hover:bg-yellow-600 transition-colors" data-index="${index}">Editar</button>
                            <button class="delete-btn bg-red-500 text-white p-2 rounded-md font-semibold hover:bg-red-600 transition-colors" data-index="${index}">Deletar</button>
                        </div>
                    `;
                    valuesContainer.appendChild(itemDiv);
                });

                // Adiciona event listeners aos botões de edição e exclusão
                valuesContainer.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => handleEdit(e.target.dataset.index, items));
                });
                valuesContainer.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => handleDelete(e.target.dataset.index, items));
                });
            }
        }

        // Função para adicionar um novo valor
        async function handleAdd() {
            const newValue = newValueInput.value.trim();
            if (!newValue) {
                displayError('Por favor, digite um valor válido.');
                return;
            }
            errorMessageElement.classList.add('hidden');

            try {
                // Cria um novo item com um ID único e o valor
                const newItem = { id: Date.now().toString(), value: newValue };

                // Atualiza o documento no Firestore adicionando o novo item ao array
                await updateDoc(publicValuesRef, {
                    items: arrayUnion(newItem)
                }, { merge: true });

                newValueInput.value = '';
            } catch (error) {
                console.error("Erro ao adicionar valor:", error);
                displayError("Não foi possível adicionar o valor. Verifique a conexão.");
            }
        }

        // Função para editar um valor existente
        async function handleEdit(index, items) {
            const oldValue = items[index].value;
            const newValue = prompt("Digite o novo valor:", oldValue);
            if (newValue && newValue.trim() !== oldValue) {
                try {
                    // Cria uma cópia do array para editar
                    const updatedItems = [...items];
                    const itemToUpdate = updatedItems[index];

                    // Remove o item antigo e adiciona o novo (simulando uma atualização)
                    await updateDoc(publicValuesRef, {
                         items: arrayRemove(itemToUpdate)
                    });
                    
                    await updateDoc(publicValuesRef, {
                        items: arrayUnion({ id: itemToUpdate.id, value: newValue.trim() })
                    });

                } catch (error) {
                    console.error("Erro ao editar valor:", error);
                    displayError("Não foi possível editar o valor. Tente novamente.");
                }
            }
        }

        // Função para deletar um valor
        async function handleDelete(index, items) {
            const itemToDelete = items[index];
            if (confirm("Tem certeza que deseja deletar este item?")) {
                try {
                    await updateDoc(publicValuesRef, {
                        items: arrayRemove(itemToDelete)
                    });
                } catch (error) {
                    console.error("Erro ao deletar valor:", error);
                    displayError("Não foi possível deletar o valor. Tente novamente.");
                }
            }
        }

        // Adiciona event listeners aos botões
        addValueButton.addEventListener('click', handleAdd);

        // Inicia a aplicação
        initFirebase();
    </script>
</body>
</html>
