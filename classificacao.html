<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initi            flex: 0 1 auto;
            margin-left: 0.3rem;
            font-weight: 700;
            font-size: 1.4rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #1a365d;
            max-width: 22ch; /* Aumentado para 22 caracteres */
            min-width: 100px;
            width: 22ch; /* Aumentado para 22 caracteres */0">
    <title>Classificação da Corrida - KDM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Libre+Franklin:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-fundo: #0076c0;
            --cor-letras: #fefefc;
            --cor-destaque-1: #FFD700; /* Ouro */
            --cor-destaque-2: #C0C0C0; /* Prata */
            --cor-destaque-3: #CD7F32; /* Bronze */
            --cor-azul-claro: #87CEEB; /* Azul claro para destaque */
            --cor-azul-medio: #4682B4; /* Azul médio */
        }

        body {
            font-family: 'Libre Franklin', sans-serif;
            background: linear-gradient(135deg, #0076c0 0%, #005a9e 100%);
            color: var(--cor-letras);
            min-height: 100vh;
            padding: 1rem;
            position: relative;
        }

        /* Oculta a barra de rolagem (mantém o scroll) */
        /* Firefox */
        html {
            scrollbar-width: none; /* esconde a barra */
        }
        /* Chrome/Edge/Safari */
        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        /* Imagem de fundo translúcida */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('KDM-F1.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.3;
            z-index: -1;
        }

        h1, h2 {
            font-family: 'Bebas Neue', sans-serif;
            color: var(--cor-letras);
        }
        
        /* Estilos específicos para os itens da lista de classificação */
        .posicao-item {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin-bottom: 0.6rem;
            border-radius: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            min-height: 60px;
            background: linear-gradient(135deg, var(--cor-azul-claro) 0%, var(--cor-azul-medio) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative; /* Adicionado para controle de posicionamento */
            width: 100%; /* Garante largura total */
        }

        .posicao-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Ajustes para modo retrato */
        @media (orientation: portrait) {
            .posicao-item {
                flex-wrap: nowrap;
                gap: 0.5rem;
                padding: 1rem;
            }

            .posicao-item .tempo-container {
                position: static;
                margin-left: auto;
            }
        }

        .posicao-item .posicao {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.4rem;
            font-weight: bold;
            width: 2.8rem;
            text-align: center;
            color: #1a365d;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            padding-right: 0.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .posicao-item .posicao-img {
            width: 2.8rem;
            height: auto;
            object-fit: contain;
        }
        
        .posicao-item.bg-yellow-400 .posicao,
        .posicao-item.bg-gray-300 .posicao,
        .posicao-item.bg-yellow-800 .posicao {
            color: #111;
        }        /* Adicione este CSS dentro da tag <style> existente */
        
        .leaderboard-container {
            position: relative;
            overflow: hidden;
            height: 600px; /* Altura fixa para o container */
        }
        
        #listaClassificacao {
            position: relative;
        }
        
        .scroll-container {
            position: relative;
            height: calc(100% - 70px); /* Altura total menos o título */
            overflow: hidden;
        }
        
        .scroll-content {
            position: relative;
            transition: transform 1s linear;
        }
        
        /* Mantenha os estilos do top 3 sempre visíveis */
        .posicao-item.primeiro,
        .posicao-item.segundo,
        .posicao-item.terceiro {
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .posicao-item .nome {
            flex: 0 1 auto;
            margin-left: 0.3rem;
            font-weight: 700;
            font-size: 1.6rem; /* Aumentado de 1.2rem para 1.6rem */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #1a365d;
            max-width: 22ch;
            min-width: 100px;
            width: 22ch;
        }

        .posicao-item .tempo {
            font-family: monospace;
            font-weight: 700;
            font-size: 1.4rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            color: #1a365d;
        }

        .tempo-container {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 0.5rem 1rem;
            border-radius: 0.3rem;
            min-width: 8rem;
            text-align: right;
            white-space: nowrap;
            position: relative;
            z-index: 1;
            margin-left: auto;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.2rem;
        }

        .tempo-diferenca {
            font-size: 0.9rem;
            color: #1a365d;
            opacity: 0.8;
            font-family: monospace;
        }

        /* Diferença de tempo em vermelho para 2º e 3º lugares */
        .posicao-item.segundo .tempo-diferenca,
        .posicao-item.terceiro .tempo-diferenca {
            color: #FF0000;
            opacity: 1;
            font-weight: bold;
        }

        /* Estrutura do item de posição */
        .posicao-item {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Alinha itens à esquerda */
            gap: 1rem; /* Espaçamento consistente entre elementos */
            width: 100%;
        }

        /* Container para nome do piloto */
        .flex-1 {
            flex: 0 1 auto; /* Não cresce, pode encolher, tamanho base auto */
            min-width: 0; /* Permite que o texto seja truncado */
            margin-right: 1rem; /* Espaço consistente antes do tempo */
        }

        /* Ajustes específicos para o top 3 */
        .posicao-item.primeiro .tempo-container,
        .posicao-item.segundo .tempo-container,
        .posicao-item.terceiro .tempo-container {
            background-color: rgba(255, 255, 255, 0.6);
        }

        /* Top 3 com cores especiais */
        .posicao-item.primeiro {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 2px solid #FF8C00;
        }

        .posicao-item.segundo {
            background: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%);
            border: 2px solid #808080;
        }

        .posicao-item.terceiro {
            background: linear-gradient(135deg, #CD7F32 0%, #B8860B 100%);
            border: 2px solid #8B4513;
        }

        .posicao-item.primeiro .posicao,
        .posicao-item.primeiro .nome,
        .posicao-item.primeiro .tempo {
            color: #1a365d;
        }

        .posicao-item.segundo .posicao,
        .posicao-item.segundo .nome,
        .posicao-item.segundo .tempo {
            color: #1a365d;
        }

        .posicao-item.terceiro .posicao,
        .posicao-item.terceiro .nome,
        .posicao-item.terceiro .tempo {
            color: #1a365d;
        }

        /* Container principal otimizado para modo retrato */
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* encosta à direita */
            justify-content: center; /* centraliza verticalmente */
            min-height: 100vh;
            gap: 2rem;
            position: relative;
            z-index: 1;
            padding-right: 2rem; /* afastamento da borda direita */
        }

        /* Leaderboard container */
        .leaderboard-container {
            width: 80%;
            max-width: 750px; /* Reduzido mais um pouco */
            background: rgba(0, 0, 0, 0.4);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-left: auto; /* Move para a direita */
            margin-right: 0.3rem; /* Reduzido ainda mais para ficar bem próximo à direita */
            height: 90vh;
            overflow: hidden;
        }

        .top-3-fixed {
            position: sticky;
            top: 0;
            z-index: 10;
            background: transparent;
            padding-bottom: 1rem;
        }

        .scroll-wrapper {
            height: calc(100% - 250px);
            overflow: hidden;
            position: relative;
        }

        .scroll-content {
            animation: scrollAnimation 120s linear infinite;
            will-change: transform;
            padding-bottom: 2rem; /* Espaço extra no final */
        }

        @keyframes scrollAnimation {
            0% { transform: translateY(0); }
            100% { transform: translateY(calc(-1 * var(--scroll-distance, 0px))); }
        }

        .scroll-wrapper {
            height: calc(100% - 280px); /* Ajuste para melhor visualização */
            overflow: hidden;
            position: relative;
            margin-top: 20px;
        }

        .leaderboard-title {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Botão de navegação */
        .nav-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 1000;
            cursor: pointer;
            display: inline-block;
        }

        /* Botão secundário abaixo do voltar */
        .nav-button-secondary {
            top: 120px; /* mais abaixo do botão principal */
        }

        /* Botão no canto superior direito */
        .nav-button-right {
            right: 20px;
            left: auto;
            top: 20px;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.5);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            color: #0076c0;
        }

        .nav-button:active {
            transform: translateY(0);
            background: rgba(255, 255, 255, 0.6);
        }

        /* Responsividade para modo retrato */
        @media (max-width: 768px) {
            .leaderboard-container {
                width: 95%;
                padding: 1.5rem;
                margin: 0 auto; /* em telas pequenas, centraliza horizontalmente */
            }
            
            .leaderboard-title {
                font-size: 2rem;
            }
            
            .posicao-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                padding: 0.6rem;
            }
            
            .posicao-item .nome {
                margin-left: 0;
                margin-top: 0.5rem;
            }
            
            .tempo-container {
                margin-top: 0.5rem;
                align-self: flex-end;
            }
        }

        /* Otimização para telas em modo retrato */
        @media (orientation: portrait) {
            .main-container {
                padding: 1rem;
                display: flex;
                justify-content: center; /* Centraliza um pouco mais para cima */
            }
            
            .leaderboard-container {
                width: 85%;
                max-width: 750px;
                margin-right: 0.3rem; /* Margem mínima à direita */
            }
        }

        /* Ajustes para telas muito largas */
        @media (min-width: 1200px) {
            .leaderboard-container {
                max-width: 1200px; /* Reduzido para um tamanho mais adequado */
            }
        }
    </style>
</head>
<body class="bg-[#0076c0] text-[#fefefc]">
    
    <!-- Botões de navegação -->
    <a href="index.html" class="nav-button" id="back-button">← Voltar ao Registro</a>
    <a href="#" class="nav-button nav-button-right" id="start-presentation">Apresentação</a>

    <div class="main-container">
        <!-- Container do Leaderboard -->
        <div class="leaderboard-container">
            <h1 class="leaderboard-title">🏁 CLASSIFICAÇÃO 🏁</h1>
            <div id="listaClassificacao" class="w-full space-y-2">
                <!-- A lista de corredores será renderizada aqui pelo JavaScript -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, getDocs, doc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase - Projeto dashboard-corrida-kdm
        const firebaseConfig = {
            apiKey: "AIzaSyB2vluI975aGAGP9AyEPDIIbVQ-U5KFsuw",
            authDomain: "dashboard-corrida-kdm.firebaseapp.com",
            projectId: "dashboard-corrida-kdm",
            storageBucket: "dashboard-corrida-kdm.firebasestorage.app",
            messagingSenderId: "207183988835",
            appId: "1:207183988835:web:5369709d78839805651056",
            measurementId: "G-5E41YX6JK4"
        };
        
        const appId = 'dashboard-corrida-kdm'; // ID único para sua aplicação
        const initialAuthToken = null; // Não precisa de token customizado

        let db, auth;
        let authReady = false;

        // Configura o nível de log do Firebase para debug
        setLogLevel('debug');

        function parseTempo(tempoStr) {
            if (!tempoStr) return 0;
            
            // Remove dois pontos se existirem (para compatibilidade)
            const tempoLimpo = tempoStr.replace(/:/g, '');
            
            if (tempoLimpo.length !== 7) return 0;
            
            const minutos = Number(tempoLimpo.substring(0, 2));
            const segundos = Number(tempoLimpo.substring(2, 4));
            const milissegundos = Number(tempoLimpo.substring(4, 7));
            
            return minutos * 60000 + segundos * 1000 + milissegundos;
        }

        function formatarTempo(tempoMs) {
            const ms = tempoMs % 1000;
            const segundosTotal = Math.floor(tempoMs / 1000);
            const segundos = segundosTotal % 60;
            const minutos = Math.floor(segundosTotal / 60);

            const pad = num => num.toString().padStart(2, '0');
            const padMs = num => num.toString().padStart(3, '0');

            return `${pad(minutos)}:${pad(segundos)}:${padMs(ms)}`;
        }

        function formatarDiferenca(diferencaMs) {
            const ms = Math.abs(diferencaMs) % 1000;
            const segundosTotal = Math.floor(Math.abs(diferencaMs) / 1000);
            const segundos = segundosTotal % 60;
            const minutos = Math.floor(segundosTotal / 60);

            const pad = num => num.toString().padStart(2, '0');
            const padMs = num => num.toString().padStart(3, '0');

            return `${pad(minutos)}:${pad(segundos)}:${padMs(ms)}`;
        }

        function iniciarAnimacaoScroll() {
            const scrollContent = document.querySelector('.scroll-content');
            const contentHeight = scrollContent.offsetHeight;
            const containerHeight = document.querySelector('.scroll-container').offsetHeight;
            let scrollPosition = 0;
            let scrollingDown = true;
            
            function animate() {
                if (scrollingDown) {
                    scrollPosition += 1;
                    if (scrollPosition >= contentHeight - containerHeight) {
                        scrollingDown = false;
                        setTimeout(() => animate(), 2000); // Pausa de 2s no final
                        return;
                    }
                } else {
                    scrollPosition -= 1;
                    if (scrollPosition <= 0) {
                        scrollingDown = true;
                        setTimeout(() => animate(), 2000); // Pausa de 2s no início
                        return;
                    }
                }
                
                scrollContent.style.transform = `translateY(-${scrollPosition}px)`;
                requestAnimationFrame(animate);
            }

            setTimeout(() => animate(), 2000); // Início após 2s
        }

        const ANIM_DURATION_SECONDS = 120; // ajuste a velocidade do scroll aqui

        function renderizarClassificacao(corredores) {
            const listaClassificacao = document.getElementById('listaClassificacao');
            
            // Limita a 50 corredores e ordena por tempo
            const corredoresLimitados = corredores.slice(0, 50);
            
            // Estrutura base do leaderboard
            listaClassificacao.innerHTML = `
                <div class="top-3-fixed"></div>
                <div class="scroll-wrapper">
                    <div class="scroll-content"></div>
                </div>
            `;

            if (corredores.length === 0) {
                listaClassificacao.innerHTML = '<p class="text-center italic text-lg">Nenhum corredor registrado ainda.</p>';
                return;
            }

            corredoresLimitados.forEach((corredor, index) => {
                const posicao = index + 1;
                const tempoFormatado = formatarTempo(corredor.tempoMs);
                
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('posicao-item');

                // Limita o nome a 22 caracteres com reticências
                const nomeFormatado = corredor.nome.length > 22 ? 
                    corredor.nome.substring(0, 22) + '...' : 
                    corredor.nome;

                // Calcula a diferença de tempo para o corredor anterior
                let diferenca = '';
                if (posicao > 1) {
                    const tempoAnterior = corredoresLimitados[index - 1].tempoMs;
                    const difMs = corredor.tempoMs - tempoAnterior;
                    const difFormatada = formatarDiferenca(difMs);
                    diferenca = `<span class="tempo-diferenca">(-${difFormatada})</span>`;
                }

                itemDiv.innerHTML = `
                    <span class="posicao">
                        ${posicao === 1 ? '<img src="Primeiro.png" class="posicao-img" alt="1º">' :
                          posicao === 2 ? '<img src="Segundo.png" class="posicao-img" alt="2º">' :
                          posicao === 3 ? '<img src="Terceiro.png" class="posicao-img" alt="3º">' :
                          `${posicao}º`}
                    </span>
                    <div class="flex-1 flex flex-col">
                        <span class="nome" title="${corredor.nome}">${nomeFormatado}</span>
                    </div>
                    <div class="tempo-container">
                        <span class="tempo">${tempoFormatado}</span>
                        ${diferenca}
                    </div>
                `;

                // Adiciona classes especiais para os três primeiros
                if (posicao <= 3) {
                    itemDiv.classList.add(posicao === 1 ? 'primeiro' : posicao === 2 ? 'segundo' : 'terceiro');
                    listaClassificacao.querySelector('.top-3-fixed').appendChild(itemDiv);
                } else {
                    itemDiv.classList.add('original');
                    listaClassificacao.querySelector('.scroll-content').appendChild(itemDiv);
                }
            });

            // Loop contínuo robusto: duplica a sequência do 4º em diante até cobrir o container
            const scrollContent = listaClassificacao.querySelector('.scroll-content');
            const scrollWrapper = listaClassificacao.querySelector('.scroll-wrapper');
            const originais = Array.from(scrollContent.querySelectorAll('.posicao-item.original'));
            if (originais.length > 0) {
                setTimeout(() => {
                    const primeiro = originais[0];
                    const ultimo = originais[originais.length - 1];
                    const distanciaBase = (ultimo.offsetTop + ultimo.offsetHeight) - primeiro.offsetTop; // altura da primeira sequência
                    const alturaContainer = scrollWrapper.offsetHeight;

                    if (distanciaBase <= 0) {
                        // Nada para animar
                        scrollContent.style.animation = 'none';
                        return;
                    }

                    // Garante conteúdo suficiente: repete a sequência até superar o container
                    let repeticoesNecessarias = Math.ceil(alturaContainer / distanciaBase) + 1;
                    while (repeticoesNecessarias-- > 0) {
                        const fragmento = document.createDocumentFragment();
                        originais.forEach((node) => {
                            const clone = node.cloneNode(true);
                            clone.classList.remove('original');
                            fragmento.appendChild(clone);
                        });
                        scrollContent.appendChild(fragmento);
                    }

                    // Define a distância de um ciclo (apenas a altura da sequência original)
                    document.documentElement.style.setProperty('--scroll-distance', `${distanciaBase}px`);

                    // Reinicia a animação para aplicar a nova distância e duração
                    scrollContent.style.animation = 'none';
                    scrollContent.offsetHeight; // reflow
                    scrollContent.style.animation = `scrollAnimation ${ANIM_DURATION_SECONDS}s linear infinite`;
                }, 200);
            }
        }

        const getCollectionRef = () => {
            return collection(db, `artifacts/${appId}/public/data/corredores`);
        };

        function iniciarListenerBancoDeDados() {
            if (!authReady) {
                console.warn("A autenticação do Firebase ainda não está pronta.");
                return;
            }
            const q = query(getCollectionRef());
            onSnapshot(q, (snapshot) => {
                const corredores = [];
                snapshot.forEach((doc) => {
                    corredores.push({ ...doc.data(), id: doc.id });
                });
                // Ordena por tempo e pega os 50 melhores tempos
                corredores.sort((a, b) => a.tempoMs - b.tempoMs);
                const top50Corredores = corredores.slice(0, 50);
                renderizarClassificacao(top50Corredores);
            }, (error) => {
                console.error("Erro ao obter dados em tempo real:", error);
            });
        }

        // Inicializa o Firebase e a autenticação
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Inicializa sem autenticação para simplificar
        try {
            authReady = true;
            console.log("Firebase inicializado sem autenticação");
            iniciarListenerBancoDeDados();
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
        }

        // Garantir que o botão de navegação funcione
        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.getElementById('back-button');
            const startButton = document.getElementById('start-presentation');

            if (backButton) {
                backButton.addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
            }

            if (startButton) {
                let didNavigate = false;
                const goToPresentation = (e) => {
                    if (e) { e.preventDefault(); e.stopPropagation(); }
                    if (didNavigate) return;
                    didNavigate = true;
                    if (backButton) backButton.style.display = 'none';
                    if (startButton) startButton.style.display = 'none';
                    // Navega sem adicionar ao histórico
                    location.replace('apresentacao.html');
                };
                startButton.addEventListener('click', goToPresentation, { once: true });
                startButton.addEventListener('touchend', goToPresentation, { passive: false, once: true });
                startButton.addEventListener('pointerdown', goToPresentation, { once: true });
            }
        });
    </script>
</body>
</html>
